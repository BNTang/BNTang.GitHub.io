{"title":"MongoDB-索引生存时间","date":"2022-08-28T12:43:51.000Z","date_formatted":{"ll":"Aug 28, 2022","L":"08/28/2022","MM-DD":"08-28"},"link":"2022/08/28/MongoDB/索引/07-MongoDB-索引生存时间","tags":["MongoDB"],"updated":"2022-08-28T12:52:42.687Z","content":"<h1 id=\"索引生存时间\">索引生存时间<a title=\"#索引生存时间\" href=\"#索引生存时间\"></a></h1>\n<p>针对日期字段或者包含日期的数组字段, 我们可以在创建索引的时候, 指定索引的生存时间, 一旦索引超过了指定的生存时间, 那么 MongoDB 会自动删除超过生存时间的文档。</p>\n<p>书写格式：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.&lt;collection&gt;.createIndex(<span class=\"hljs-punctuation\">&#123;</span>&lt;field&gt;<span class=\"hljs-punctuation\">:</span>&lt;<span class=\"hljs-number\">1</span> or <span class=\"hljs-number\">-1</span>&gt;<span class=\"hljs-punctuation\">,</span> ...<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-punctuation\">&#123;</span>expireAfterSeconds<span class=\"hljs-punctuation\">:</span>second<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>创建索引，在创建的过程通过 <code>expireAfterSeconds</code> 添加过期时间：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.createIndex(<span class=\"hljs-punctuation\">&#123;</span>addTime<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-punctuation\">&#123;</span>expireAfterSeconds<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">5</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>添加数据：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.insert(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;zs&#x27;<span class=\"hljs-punctuation\">,</span> addTime<span class=\"hljs-punctuation\">:</span>new Date()<span class=\"hljs-punctuation\">&#125;</span>)<br>db.person.insert(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;ls&#x27;<span class=\"hljs-punctuation\">,</span> addTime<span class=\"hljs-punctuation\">:</span>new Date()<span class=\"hljs-punctuation\">&#125;</span>)<br>db.person.insert(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;ww&#x27;<span class=\"hljs-punctuation\">,</span> addTime<span class=\"hljs-punctuation\">:</span>new Date()<span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>!&gt; MongoDB 会定期清理超过时间的文档, 但是无法保证即时性(也就是设置的过期时间是 1 秒, 但是可能 3 秒后才会清除)</p>\n<p>!&gt; 复合索引字段是不具备生存时间特性的, 也就是不能在复合索引中指定生存时间</p>\n<p>!&gt; 当数组字段中包含多个日期, 我们给数组字段设置生存时间时, 系统会按照数组中 <code>最小</code> 的时间来计算生存时间, 例如: {name:‘BNTang’, times:[‘2022-04-16 09:13:33’,‘2022-04-16 07:13:33’,‘2022-04-16 08:13:33’]} 会按照 ‘2022-04-16 07:13:33’ 来计算生存时间</p>\n","prev":{"title":"MongoDB-删除索引","link":"2022/08/28/MongoDB/索引/08-MongoDB-删除索引"},"next":{"title":"MongoDB-稀疏索引","link":"2022/08/28/MongoDB/索引/06-MongoDB-稀疏索引"},"plink":"http://example.com/2022/08/28/MongoDB/索引/07-MongoDB-索引生存时间/","toc":[{"id":"索引生存时间","title":"索引生存时间","index":"1"}],"reading_time":"312 words in 2 min"}