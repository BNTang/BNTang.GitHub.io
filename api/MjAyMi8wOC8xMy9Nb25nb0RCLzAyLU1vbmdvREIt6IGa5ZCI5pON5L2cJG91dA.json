{"title":"MongoDB-聚合操作$out","date":"2022-08-13T10:32:56.000Z","date_formatted":{"ll":"Aug 13, 2022","L":"08/13/2022","MM-DD":"08-13"},"link":"2022/08/13/MongoDB/02-MongoDB-聚合操作$out","tags":["MongoDB"],"updated":"2022-08-14T08:28:51.247Z","content":"<h1 id=\"聚合管道阶段\">聚合管道阶段<a title=\"#聚合管道阶段\" href=\"#聚合管道阶段\"></a></h1>\n<ul>\n<li><code>$out</code>: 将前面阶段处理完的文档写入一个新的集合</li>\n</ul>\n<p>格式:</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span>$out<span class=\"hljs-punctuation\">:</span> &lt;new collection name&gt;<span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<h1 id=\"示例\">示例<a title=\"#示例\" href=\"#示例\"></a></h1>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.aggregate(<span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>        $group<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">&#123;</span><br>            _id<span class=\"hljs-punctuation\">:</span> &#x27;$city&#x27;<span class=\"hljs-punctuation\">,</span><br>            totalAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$sum<span class=\"hljs-punctuation\">:</span>&#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            avgAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$avg<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            minAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$min<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            maxAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$max<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            totalAges<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$push<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>        $out<span class=\"hljs-punctuation\">:</span>&#x27;newPerson&#x27;<br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">]</span>)<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.newPerson.find()<br></code></pre></td></tr></table></figure>\n<h1 id=\"注意点\">注意点<a title=\"#注意点\" href=\"#注意点\"></a></h1>\n<ul>\n<li>如果利用 <code>$out</code> 写入一个已经存在的集合, 那么集合中的原有数据会被覆盖</li>\n<li>如下图片当中的数据是第一次进行写入的</li>\n</ul>\n<p><img src=\"/2022/08/13/MongoDB/02-MongoDB-%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C$out/img.png\" alt=\"img.png\" loading=\"lazy\" class=\"φbp\"></p>\n<p>再次执行 $out：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.aggregate(<span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>        $group<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">&#123;</span><br>            _id<span class=\"hljs-punctuation\">:</span> &#x27;$city&#x27;<span class=\"hljs-punctuation\">,</span><br>            totalAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$sum<span class=\"hljs-punctuation\">:</span>&#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            avgAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$avg<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            minAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$min<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            maxAge<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span>$max<span class=\"hljs-punctuation\">:</span> &#x27;$age&#x27;<span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>        $out<span class=\"hljs-punctuation\">:</span>&#x27;newPerson&#x27;<br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">]</span>)<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.newPerson.find()<br></code></pre></td></tr></table></figure>\n<p>之后的数据如下：</p>\n<p><img src=\"/2022/08/13/MongoDB/02-MongoDB-%E8%81%9A%E5%90%88%E6%93%8D%E4%BD%9C$out/img2.png\" alt=\"img.png\" loading=\"lazy\" class=\"φbp\"></p>\n<p>发现 totalAges 已经没有了。</p>\n<ul>\n<li>如果通过 $out 将结果写入一个集合当中，如果这个集合不存在，那么就会自动创建，这个注意点不演示自行探索测试</li>\n</ul>\n","prev":{"title":"MongoDB-聚合操作额外配置","link":"2022/08/13/MongoDB/03-MongoDB-聚合操作额外配置"},"next":{"title":"MongoDB-聚合操作$group","link":"2022/08/13/MongoDB/01-MongoDB-聚合操作$group"},"plink":"http://example.com/2022/08/13/MongoDB/02-MongoDB-聚合操作$out/","toc":[{"id":"聚合管道阶段","title":"聚合管道阶段","index":"1"},{"id":"示例","title":"示例","index":"2"},{"id":"注意点","title":"注意点","index":"3"}],"reading_time":"279 words in 2 min"}