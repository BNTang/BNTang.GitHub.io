{"title":"Keepalived 安装与配置","date":"2023-05-28T13:34:36.000Z","date_formatted":{"ll":"May 28, 2023","L":"05/28/2023","MM-DD":"05-28"},"link":"2023/05/28/DevOps与云原生/Keepalive+Haproxy 高可用搭建/05-keepalive安装与配置","tags":["Keepalive+Haproxy 高可用搭建"],"updated":"2023-07-09T03:21:47.590Z","content":"<h1 id=\"安装-keepalived\">安装 Keepalived<a title=\"#安装-keepalived\" href=\"#安装-keepalived\"></a></h1>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">apt -y install keepalived<br></code></pre></td></tr></table></figure>\n<p>里边有一个杠y，就是我安装的时候里面有yes，就直接是yes</p>\n<h1 id=\"添加-keepalived-配置\">添加 Keepalived 配置<a title=\"#添加-keepalived-配置\" href=\"#添加-keepalived-配置\"></a></h1>\n<p>安装好之后, 下一步就开始去来写这个配置文件了，就在这里面去建一个 <code>etc</code> 当中，就是在这个 <code>etc</code> 当中建一个这个 Keepalived 的 config 这样的一个文件:</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">mkdir</span> -p /etc/keepalived &amp;&amp; <span class=\"hljs-built_in\">touch</span> /etc/keepalived/keepalived.conf<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">chmod</span> 644 /etc/keepalived/keepalived.conf<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">vim /etc/keepalived/keepalived.conf<br></code></pre></td></tr></table></figure>\n<p>第一台机器 Keepalived 配置文件内容:</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">! Configuration File for keepalived<br>global_defs &#123;<br>   # 指定router_id<br>   router_id ha01<br>&#125;<br>vrrp_script check_haproxy &#123;<br>   # 定义脚本<br>   script &quot;/etc/keepalived/check_haproxy.sh&quot;<br>   interval 1<br>   weight -30<br>   fall 3<br>   rise 2<br>   timeout 2<br>&#125;<br>vrrp_instance VI_1 &#123;<br>   # 在ha2上为 BACKUP<br>   state MASTER<br>   interface eth0<br>   garp_master_delay 10<br>   smtp_alert<br>   # 指定虚拟路由器ID, ha1和ha2此值必须相同<br>   virtual_router_id 66<br>   # 在ha2上为80, 代表着这台机器的权限比ha2高<br>   priority 100<br>   advert_int 1<br>   authentication &#123;<br>       auth_type PASS<br>       # 指定验证密码, ha1和ha2此值必须相同<br>       auth_pass 123456<br>   &#125;<br>   virtual_ipaddress &#123;<br>        # 指定VIP, ha1和ha2此值必须相同<br>        192.168.0.101/24 dev eth0 label eth0:1<br>   &#125;<br>   track_script &#123;<br>       # 调用上面定义的脚本<br>       check_haproxy<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>!&gt; interface eth0 当中的 eth0 如何得来：</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202307/2105804-20230709104003342-637840483.png\" alt=\"image-20230709104002199\" loading=\"lazy\" class=\"φbp\"></p>\n<p>几个关键的点：</p>\n<ul>\n<li>interface eth0：对应的这个网卡名称，要看你现在你电脑里边的这个主网卡的这个名称是什么，那这个地方你就写什么</li>\n<li>virtual_router_id：两台这个地方要相同, 指定虚拟路由器ID</li>\n<li>priority: 优先级, 就是说我去找的时候哪个优先级高就先去找哪个</li>\n<li>authentication: 两个互相访问的时候验证的一个这个密码，那么这个密码两台机器上必须设置一样</li>\n<li>virtual_ipaddress: 虚拟IP，就是我们那个 VIP</li>\n</ul>\n<p>我们刚才来申请的这个 IP 是不是 192.168.0.101，那你呢？就把这个 192.168.0.101 配置进去，好，改一下之后你看这在这中间是不是有这个 eth0，我们第一个这个网卡，那么下面这个地方就是你的虚拟 IP 虚拟 IP 绑定哪个地方？就是到时候绑定到 eth0:1 上面。</p>\n<p>搞定之后这是一个脚本，这个脚本我们等会来去创建，我们现在先去把这个配置文件给写好。</p>\n<p>等会把它配置上之后，启动了 Keeppalived 之后，然后再去看这个 ifconfig</p>\n<p>第二台机器 Keepalived 配置文件内容:</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">! Configuration File for keepalived<br>global_defs &#123;<br>   # 指定router_id<br>   router_id ha02<br>&#125;<br>vrrp_script check_haproxy &#123;<br>   # 定义脚本<br>   script &quot;/etc/keepalived/check_haproxy.sh&quot;<br>   interval 1<br>   weight -30<br>   fall 3<br>   rise 2<br>   timeout 2<br>&#125;<br>vrrp_instance VI_1 &#123;<br>   # 在ha2上为 BACKUP<br>   state BACKUP<br>   interface eth0<br>   garp_master_delay 10<br>   smtp_alert<br>   # 指定虚拟路由器ID, ha1和ha2此值必须相同<br>   virtual_router_id 66<br>   # 在ha2上为80, 代表着这台机器的权限比ha2高<br>   priority 80<br>   advert_int 1<br>   authentication &#123;<br>       auth_type PASS<br>       # 指定验证密码, ha1和ha2此值必须相同<br>       auth_pass 123456   <br>   &#125;<br>   virtual_ipaddress &#123;<br>        # 指定VIP, ha1和ha2此值必须相同<br>        192.168.0.101/24 dev eth0 label eth0:1  <br>   &#125;<br>   track_script &#123;<br>       # 调用上面定义的脚本<br>       check_haproxy <br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>刚才那个叫 MASTER，这个叫一个 BACKUP，其它的基本上一样改了一下优先级为 80, 好了第二台机子已经创建好了配置文件接下来就是创建脚本启动了。</p>\n<h1 id=\"创建-keepalived-健康脚本\">创建 Keepalived 健康脚本<a title=\"#创建-keepalived-健康脚本\" href=\"#创建-keepalived-健康脚本\"></a></h1>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">cat</span> &gt; /etc/keepalived/check_haproxy.sh &lt;&lt;<span class=\"hljs-string\">EOF</span><br><span class=\"hljs-string\">#!/bin/bash</span><br><span class=\"hljs-string\">/usr/bin/killall -0 haproxy || systemctl restart haproxy</span><br><span class=\"hljs-string\">EOF</span><br></code></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-built_in\">chmod</span> a+x /etc/keepalived/check_haproxy.sh<br></code></pre></td></tr></table></figure>\n<p>如果运行启动 keepalived 命名报：Failed to restart keepalived.service: Unit keepalived.service not found.</p>\n<p>该错误信息指示无法找到名为&quot;keepalived.service&quot;的服务单元。这可能是由于未安装Keepalived或未正确配置Keepalived服务导致的。（也就是说没有安装 keepalived）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">systemctl restart keepalived<br></code></pre></td></tr></table></figure>\n<p>启动完毕之后，我们在第一天机器上输入 ifconfig：</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202307/2105804-20230709111340130-1232681081.png\" alt=\"image-20230709111339008\" loading=\"lazy\" class=\"φbp\"></p>\n<p>发现，已经对应上了我们申请下来的虚拟ID，好了完毕到此结束。我们现在的虚拟ID在第一台机器上面，我们将第一台机器进行关机在查看我们第二台机器的 ifconfig 信息看看虚拟ID有没有漂移到健康状态的机器当中。</p>\n<p>139.9.50.116 关机:</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202307/2105804-20230709111709157-2036506398.png\" alt=\"image-20230709111708467\" loading=\"lazy\" class=\"φbp\"></p>\n<p>查看 116.205.227.222:</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202307/2105804-20230709111653030-1939946862.png\" alt=\"image-20230709111652169\" loading=\"lazy\" class=\"φbp\"></p>\n<p>139.9.50.116 开机:</p>\n<p>查看 139.9.50.116:</p>\n<p>查看 116.205.227.222:</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202307/2105804-20230709111852196-491524215.png\" alt=\"image-20230709111851489\" loading=\"lazy\" class=\"φbp\"></p>\n<p>好了我们 116 复活之后又回来了，我们的 Keepalived 安装与配置就介绍到这。</p>\n","prev":{"title":"常见的for循环优化方式","link":"2023/06/01/Java/Java开发细节规范与优化细节/01-常见的for循环优化方式"},"next":{"title":"华为云虚拟IP申请","link":"2023/05/28/DevOps与云原生/Keepalive+Haproxy 高可用搭建/04-华为云虚拟IP申请"},"plink":"http://example.com/2023/05/28/DevOps与云原生/Keepalive+Haproxy 高可用搭建/05-keepalive安装与配置/","toc":[{"id":"安装-keepalived","title":"安装 Keepalived","index":"1"},{"id":"添加-keepalived-配置","title":"添加 Keepalived 配置","index":"2"},{"id":"创建-keepalived-健康脚本","title":"创建 Keepalived 健康脚本","index":"3"}],"reading_time":"1205 words in 8 min"}