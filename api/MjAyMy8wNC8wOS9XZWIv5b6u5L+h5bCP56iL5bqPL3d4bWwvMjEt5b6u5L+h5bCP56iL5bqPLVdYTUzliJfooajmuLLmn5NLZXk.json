{"title":"微信小程序-WXML列表渲染Key","date":"2023-04-08T17:02:57.000Z","date_formatted":{"ll":"Apr 9, 2023","L":"04/09/2023","MM-DD":"04-09"},"link":"2023/04/09/Web/微信小程序/wxml/21-微信小程序-WXML列表渲染Key","tags":["微信小程序"],"updated":"2023-04-09T04:07:50.423Z","content":"<h1 id=\"wx:key\">wx:key<a title=\"#wx:key\" href=\"#wx:key\"></a></h1>\n<p>如果列表中项目的位置会动态改变或者有新的项目添加到列表中，并且希望列表中的项目保持自己的特征和状态（如 input 中的输入内容，switch 的选中状态），需要使用 wx:key 来指定列表中项目的唯一标识符。</p>\n<p>wx:key 的值以两种形式提供：</p>\n<ul>\n<li>字符串：代表在 for 循环的 array 中 item 的某个 property，该 property 的值需要是列表中唯一的字符串或数字，且不能动态改变。</li>\n<li>保留关键字：<code>*this</code> 代表在 for 循环中 item 本身，这种表示需要 item 本身是一个唯一的字符串或者数字。</li>\n</ul>\n<p>?&gt; 底层原理：小程序内部也使用了虚拟DOM（和Vue，React相似），通过key可以更好更快的判断是否可以复用</p>\n<p>首先来看一个不使用wx:key的情况下，我们的示例会出现什么意想不到的情况，我们现在index.js定义一个属性来存储一些数据，然后编写一个方法用来给index.wxml页面按钮点击事件使用：</p>\n<p>index.js:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs js\"><span class=\"hljs-attr\">data</span>: &#123;<br>  <span class=\"hljs-attr\">chs</span>: [<span class=\"hljs-string\">&#x27;a&#x27;</span>, <span class=\"hljs-string\">&#x27;b&#x27;</span>, <span class=\"hljs-string\">&#x27;c&#x27;</span>]<br>&#125;,<br><span class=\"hljs-attr\">_myClickHandle</span>: <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\"></span>)&#123;<br>  <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(<span class=\"hljs-string\">&quot;加之前：&quot;</span> + <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">chs</span>)<br>  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">chs</span>.<span class=\"hljs-title function_\">push</span>(<span class=\"hljs-string\">&#x27;d&#x27;</span>);<br>  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">setData</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">data</span>);<br>  <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(<span class=\"hljs-string\">&quot;加之后：&quot;</span> + <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">chs</span>)<br>&#125;,<br></code></pre></td></tr></table></figure>\n<p>index.wxml:</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">view</span> <span class=\"hljs-attr\">wx:for</span>=<span class=\"hljs-string\">&quot;&#123;&#123; chs &#125;&#125;&quot;</span>&gt;</span><br>  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">switch</span>/&gt;</span><br>  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">text</span>&gt;</span>&#123;&#123; item &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">text</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">view</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">bindtap</span>=<span class=\"hljs-string\">&quot;_myClickHandle&quot;</span>&gt;</span>按钮<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span><br></code></pre></td></tr></table></figure>\n<p>这个实例看起来一切正常，我们是往数组的后面追加元素的，我们来改造成往前面进行添加元素，更改一下_myClickHandle方法的追加方式从 push 改为 unshift：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">data</span>.<span class=\"hljs-property\">chs</span>.<span class=\"hljs-title function_\">unshift</span>(<span class=\"hljs-string\">&#x27;d&#x27;</span>);<br></code></pre></td></tr></table></figure>\n<p>再次运行我们的程序结果如下：</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202304/2105804-20230409115325115-1421928397.gif\" alt=\"a\" loading=\"lazy\" class=\"φbp\"></p>\n<p>发现我们新增的元素的开关状态自动被打开了，这个时候就出现了很严重的问题。</p>\n<p>出现问题的原因：</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202304/2105804-20230409115444598-460046546.png\" alt=\"image-20230409115444159\" loading=\"lazy\" class=\"φbp\"></p>\n<p>正是因为如此，就有了wx:key这么一个东西来解决该问题。</p>\n<p>wx:key 官方文档：<a href=\"https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/list.html#wx-key\" target=\"_blank\">https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/list.html#wx-key</a></p>\n<p>到了这里我们就知道了如果不用wx:key那么就会出现复用DOM出错的情况，那么我们就来使用下，经过上面的一帆介绍我们知道了有两种wx:key的使用方式我们先来看，保留关键字。</p>\n<h1 id=\"保留关键字\">保留关键字<a title=\"#保留关键字\" href=\"#保留关键字\"></a></h1>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202304/2105804-20230409115837840-2085559031.png\" alt=\"image-20230409115836691\" loading=\"lazy\" class=\"φbp\"></p>\n<p>如果上图的效果很显然，我们的问题已经得到了解决，那么为啥添加了wx:key那么就不会导致我们新增的元素复用错误呢，我画了张图看下图：</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202304/2105804-20230409115919752-468834029.png\" alt=\"image-20230409115919204\" loading=\"lazy\" class=\"φbp\"></p>\n<p>好了，通过上图我们可以很清楚的看明白，我们的新增元素在复用组件当中找不到所以会重新创建一个新的。</p>\n<p>如果列表渲染出来的数据不会发生变化，那么添加不添加wx:key都无所谓，但是还是建议添加，如果列表渲染出来的数据会发生变化，那么必须添加wx:key保证数据状态的正确性。</p>\n<p><code>*this</code>：表示当前遍历到的元素，也就是item中存储的内容，如果是独一无二的简单类型数据，可以使用 <code>*this</code> 但是如果是复杂类型（对象/数组）, 不能使用*this。因为给到的结构是[object object] 无法保证唯一。</p>\n<h1 id=\"字符串\">字符串<a title=\"#字符串\" href=\"#字符串\"></a></h1>\n<p>关于字符串的wx:key这里就简单弄个数据结构进行渲染即可：</p>\n<p>index.js：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-attr\">objectArray</span>: [<br>  &#123;<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">5</span>, <span class=\"hljs-attr\">unique</span>: <span class=\"hljs-string\">&#x27;unique_5&#x27;</span>&#125;,<br>  &#123;<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">4</span>, <span class=\"hljs-attr\">unique</span>: <span class=\"hljs-string\">&#x27;unique_4&#x27;</span>&#125;,<br>  &#123;<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">3</span>, <span class=\"hljs-attr\">unique</span>: <span class=\"hljs-string\">&#x27;unique_3&#x27;</span>&#125;,<br>  &#123;<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">2</span>, <span class=\"hljs-attr\">unique</span>: <span class=\"hljs-string\">&#x27;unique_2&#x27;</span>&#125;,<br>  &#123;<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">1</span>, <span class=\"hljs-attr\">unique</span>: <span class=\"hljs-string\">&#x27;unique_1&#x27;</span>&#125;,<br>  &#123;<span class=\"hljs-attr\">id</span>: <span class=\"hljs-number\">0</span>, <span class=\"hljs-attr\">unique</span>: <span class=\"hljs-string\">&#x27;unique_0&#x27;</span>&#125;,<br>],<br></code></pre></td></tr></table></figure>\n<p>index.wxml:</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">view</span> <span class=\"hljs-attr\">wx:for</span>=<span class=\"hljs-string\">&quot;&#123;&#123; objectArray &#125;&#125;&quot;</span> <span class=\"hljs-attr\">wx:key</span>=<span class=\"hljs-string\">&quot;id&quot;</span>&gt;</span><br>  <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">text</span>&gt;</span>&#123;&#123; item.unique &#125;&#125;<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">text</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">view</span>&gt;</span><br></code></pre></td></tr></table></figure>\n<p>wx:key=“id” 表示从当前遍历到的数组中获取id的值，item -&gt; object -&gt; <a href=\"http://item.id\">item.id</a>。</p>\n","prev":{"title":"微信小程序-WXML包装元素","link":"2023/04/09/Web/微信小程序/wxml/22-微信小程序-WXML包装元素"},"next":{"title":"微信小程序-WXML列表渲染","link":"2023/04/09/Web/微信小程序/wxml/20-微信小程序-WXML列表渲染"},"plink":"http://example.com/2023/04/09/Web/微信小程序/wxml/21-微信小程序-WXML列表渲染Key/","toc":[{"id":"wx:key","title":"wx:key","index":"1"},{"id":"保留关键字","title":"保留关键字","index":"2"},{"id":"字符串","title":"字符串","index":"3"}],"reading_time":"995 words in 7 min"}