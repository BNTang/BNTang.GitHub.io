{"title":"TienChin 渠道管理-渠道导入","date":"2023-09-04T15:32:42.000Z","date_formatted":{"ll":"Sep 4, 2023","L":"09/04/2023","MM-DD":"09-04"},"link":"2023/09/04/项目/TienChin 健身系统/2023-6-11/27-TienChin 渠道管理-渠道导入","tags":["项目"],"updated":"2023-09-17T15:37:36.668Z","content":"<h1 id=\"channelcontroller\">ChannelController<a title=\"#channelcontroller\" href=\"#channelcontroller\"></a></h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@PostMapping(&quot;/importTemplate&quot;)</span><br><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">importTemplate</span><span class=\"hljs-params\">(HttpServletResponse response)</span> &#123;<br>    ExcelUtil&lt;Channel&gt; util = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ExcelUtil</span>&lt;&gt;(Channel.class);<br>    util.importTemplateExcel(response, <span class=\"hljs-string\">&quot;渠道数据&quot;</span>);<br>&#125;<br><br><span class=\"hljs-meta\">@Log(title = &quot;渠道管理&quot;, businessType = BusinessType.IMPORT)</span><br><span class=\"hljs-meta\">@PreAuthorize(&quot;hasPermission(&#x27;tienchin:channel:import&#x27;)&quot;)</span><br><span class=\"hljs-meta\">@PostMapping(&quot;/importData&quot;)</span><br>AjaxResult <span class=\"hljs-title function_\">importData</span><span class=\"hljs-params\">(MultipartFile file, <span class=\"hljs-type\">boolean</span> updateSupport)</span> <span class=\"hljs-keyword\">throws</span> Exception &#123;<br>    ExcelUtil&lt;Channel&gt; util = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ExcelUtil</span>&lt;&gt;(Channel.class);<br>    List&lt;Channel&gt; channelList = util.importExcel(file.getInputStream());<br>    <span class=\"hljs-keyword\">return</span> AjaxResult.success(iChannelService.importChannel(channelList, updateSupport));<br>&#125;<br></code></pre></td></tr></table></figure>\n<h1 id=\"ichannelservice\">IChannelService<a title=\"#ichannelservice\" href=\"#ichannelservice\"></a></h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-comment\">/**</span><br><span class=\"hljs-comment\"> * 导入渠道数据</span><br><span class=\"hljs-comment\"> *</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@param</span> channelList   渠道数据列表</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@param</span> updateSupport 是否更新支持，如果已存在，则进行更新数据</span><br><span class=\"hljs-comment\"> * <span class=\"hljs-doctag\">@return</span> &#123;<span class=\"hljs-doctag\">@code</span> boolean&#125; &#123;<span class=\"hljs-doctag\">@code</span> true&#125; 导入成功 &#123;<span class=\"hljs-doctag\">@code</span> false&#125; 导入失败</span><br><span class=\"hljs-comment\"> */</span><br><span class=\"hljs-type\">boolean</span> <span class=\"hljs-title function_\">importChannel</span><span class=\"hljs-params\">(List&lt;Channel&gt; channelList, <span class=\"hljs-type\">boolean</span> updateSupport)</span>;<br></code></pre></td></tr></table></figure>\n<h1 id=\"channelserviceimpl\">ChannelServiceImpl<a title=\"#channelserviceimpl\" href=\"#channelserviceimpl\"></a></h1>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\"><span class=\"hljs-meta\">@Override</span><br><span class=\"hljs-meta\">@Transactional(rollbackFor = Exception.class)</span><br><span class=\"hljs-keyword\">public</span> <span class=\"hljs-type\">boolean</span> <span class=\"hljs-title function_\">importChannel</span><span class=\"hljs-params\">(List&lt;Channel&gt; channelList, <span class=\"hljs-type\">boolean</span> updateSupport)</span> &#123;<br>    <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">username</span> <span class=\"hljs-operator\">=</span> SecurityUtils.getUsername();<br>    <span class=\"hljs-type\">LocalDateTime</span> <span class=\"hljs-variable\">currentTime</span> <span class=\"hljs-operator\">=</span> LocalDateTime.now();<br><br>    List&lt;Channel&gt; channels = channelList<br>            .stream()<br>            .peek(channel -&gt; &#123;<br>                <span class=\"hljs-keyword\">if</span> (updateSupport) &#123;<br>                    channel.setUpdateBy(username);<br>                    channel.setUpdateTime(currentTime);<br>                &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>                    channel.setCreateBy(username);<br>                    channel.setCreateTime(currentTime);<br>                    channel.setChannelId(<span class=\"hljs-literal\">null</span>);<br>                &#125;<br>            &#125;).collect(Collectors.toList());<br><br>    <span class=\"hljs-keyword\">if</span> (updateSupport) &#123;<br>        <span class=\"hljs-keyword\">return</span> updateBatchById(channels);<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>        <span class=\"hljs-keyword\">return</span> saveBatch(channels);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>!&gt; 修复若依框架导入数据 Byte 类型数据报错的问题</p>\n<p>更改 ReflectUtils.java 中的 invokeMethodByName 方法:</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202309/2105804-20230917233341026-1413251200.png\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs java\">...<br><br><span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (cs[i] == Byte.class) &#123;<br>    args[i] = Convert.toByte(args[i]);<br>&#125;<br><br>...<br></code></pre></td></tr></table></figure>\n<h1 id=\"配置-mysql-批量插入\">配置 MySQL 批量插入<a title=\"#配置-mysql-批量插入\" href=\"#配置-mysql-批量插入\"></a></h1>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-comment\"># 批量插入</span><br><span class=\"hljs-string\">&amp;rewriteBatchedStatements=true</span><br></code></pre></td></tr></table></figure>\n<p>配置在 MySQL 的连接地址后面即可：</p>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202309/2105804-20230917233536738-1794542631.png\" alt=\"img\" loading=\"lazy\" class=\"φbp\"></p>\n<p>因为 MyBatisPlus 当中的批量插入，并没有达到我的预料效果的批量插入，所以我们需要进行配置，配置方式如上。</p>\n","prev":{"title":"TienChin 活动管理-准备工作","link":"2023/09/04/项目/TienChin 健身系统/2023-6-11/29-TienChin 活动管理-准备工作"},"next":{"title":"TienChin 渠道管理-渠道页面完善","link":"2023/09/04/项目/TienChin 健身系统/2023-6-11/28-TienChin 渠道管理-渠道页面完善"},"plink":"http://example.com/2023/09/04/项目/TienChin 健身系统/2023-6-11/27-TienChin 渠道管理-渠道导入/","toc":[{"id":"channelcontroller","title":"ChannelController","index":"1"},{"id":"ichannelservice","title":"IChannelService","index":"2"},{"id":"channelserviceimpl","title":"ChannelServiceImpl","index":"3"},{"id":"配置-mysql-批量插入","title":"配置 MySQL 批量插入","index":"4"}],"reading_time":"371 words in 2 min"}