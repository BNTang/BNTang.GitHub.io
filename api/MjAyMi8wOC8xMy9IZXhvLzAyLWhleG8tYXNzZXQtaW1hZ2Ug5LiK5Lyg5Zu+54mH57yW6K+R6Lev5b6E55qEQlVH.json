{"title":"Hexo 图片上传之 hexo-asset-image 路径编译 BUG","date":"2022-08-13T08:18:17.000Z","date_formatted":{"ll":"Aug 13, 2022","L":"08/13/2022","MM-DD":"08-13"},"link":"2022/08/13/Hexo/02-hexo-asset-image 上传图片编译路径的BUG","tags":["Hexo"],"updated":"2022-08-13T08:29:55.882Z","content":"<p>这个 BUG 的来源于是因为博主想在 hexo 当中进行本地查看的时候发现图片加载全部未显示，然后我就查看控制台编译的结果发现，路径如下:</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">update link as:--&gt;/.com/06/01/vim/1561905818946.png<br>update link as:--&gt;/.com/06/01/vim/1561905818946.png<br></code></pre></td></tr></table></figure>\n<p>生成了一个这样的路径，我当时一想这是啥路径，完全不是我想要的一个正常显示图片的路径，于是我就特意的记录了下来，可以帮助后者避免这个坑，经过我去搜寻一番，发现这个 <code>hexo-asset-image</code> 插件有问题，在 hexo 3.0 以上与 hexo3.0 以下获取 url 的方式不同，结果就导致获取到了 <code>.com</code> 这种奇怪的域名拼接在我们的图片路径当中了。</p>\n<h1 id=\"解决方式\">解决方式<a title=\"#解决方式\" href=\"#解决方式\"></a></h1>\n<h2 id=\"hexo-3.0-以下\">hexo 3.0 以下<a title=\"#hexo-3.0-以下\" href=\"#hexo-3.0-以下\"></a></h2>\n<p>修改源码找到 /node_modules/hexo-asset-image/index.js 将当中的内容替换为我如下提供的内容即可：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-meta\">&#x27;use strict&#x27;</span>;<br><span class=\"hljs-keyword\">var</span> cheerio = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;cheerio&#x27;</span>);<br><br><span class=\"hljs-comment\">// http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span><br><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">getPosition</span>(<span class=\"hljs-params\">str, m, i</span>) &#123;<br>    <span class=\"hljs-keyword\">return</span> str.<span class=\"hljs-title function_\">split</span>(m, i).<span class=\"hljs-title function_\">join</span>(m).<span class=\"hljs-property\">length</span>;<br>&#125;<br><br><span class=\"hljs-keyword\">var</span> version = <span class=\"hljs-title class_\">String</span>(hexo.<span class=\"hljs-property\">version</span>).<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;.&#x27;</span>);<br>hexo.<span class=\"hljs-property\">extend</span>.<span class=\"hljs-property\">filter</span>.<span class=\"hljs-title function_\">register</span>(<span class=\"hljs-string\">&#x27;after_post_render&#x27;</span>, <span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">data</span>) &#123;<br>    <span class=\"hljs-keyword\">var</span> config = hexo.<span class=\"hljs-property\">config</span>;<br>    <span class=\"hljs-keyword\">if</span> (config.<span class=\"hljs-property\">post_asset_folder</span>) &#123;<br>        <span class=\"hljs-keyword\">var</span> link = data.<span class=\"hljs-property\">permalink</span>;<br>        <span class=\"hljs-keyword\">if</span> (version.<span class=\"hljs-property\">length</span> &gt; <span class=\"hljs-number\">0</span> &amp;&amp; <span class=\"hljs-title class_\">Number</span>(version[<span class=\"hljs-number\">0</span>]) == <span class=\"hljs-number\">3</span>)<br>            <span class=\"hljs-keyword\">var</span> beginPos = <span class=\"hljs-title function_\">getPosition</span>(link, <span class=\"hljs-string\">&#x27;/&#x27;</span>, <span class=\"hljs-number\">1</span>) + <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-keyword\">else</span><br>            <span class=\"hljs-keyword\">var</span> beginPos = <span class=\"hljs-title function_\">getPosition</span>(link, <span class=\"hljs-string\">&#x27;/&#x27;</span>, <span class=\"hljs-number\">3</span>) + <span class=\"hljs-number\">1</span>;<br>        <span class=\"hljs-comment\">// In hexo 3.1.1, the permalink of &quot;about&quot; page is like &quot;.../about/index.html&quot;.</span><br>        <span class=\"hljs-keyword\">var</span> endPos = link.<span class=\"hljs-title function_\">lastIndexOf</span>(<span class=\"hljs-string\">&#x27;/&#x27;</span>) + <span class=\"hljs-number\">1</span>;<br>        link = link.<span class=\"hljs-title function_\">substring</span>(beginPos, endPos);<br><br>        <span class=\"hljs-keyword\">var</span> toprocess = [<span class=\"hljs-string\">&#x27;excerpt&#x27;</span>, <span class=\"hljs-string\">&#x27;more&#x27;</span>, <span class=\"hljs-string\">&#x27;content&#x27;</span>];<br>        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">var</span> i = <span class=\"hljs-number\">0</span>; i &lt; toprocess.<span class=\"hljs-property\">length</span>; i++) &#123;<br>            <span class=\"hljs-keyword\">var</span> key = toprocess[i];<br><br>            <span class=\"hljs-keyword\">var</span> $ = cheerio.<span class=\"hljs-title function_\">load</span>(data[key], &#123;<br>                <span class=\"hljs-attr\">ignoreWhitespace</span>: <span class=\"hljs-literal\">false</span>,<br>                <span class=\"hljs-attr\">xmlMode</span>: <span class=\"hljs-literal\">false</span>,<br>                <span class=\"hljs-attr\">lowerCaseTags</span>: <span class=\"hljs-literal\">false</span>,<br>                <span class=\"hljs-attr\">decodeEntities</span>: <span class=\"hljs-literal\">false</span><br>            &#125;);<br><br>            $(<span class=\"hljs-string\">&#x27;img&#x27;</span>).<span class=\"hljs-title function_\">each</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\"></span>) &#123;<br>                <span class=\"hljs-keyword\">if</span> ($(<span class=\"hljs-variable language_\">this</span>).<span class=\"hljs-title function_\">attr</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>)) &#123;<br>                    <span class=\"hljs-comment\">// For windows style path, we replace &#x27;\\&#x27; to &#x27;/&#x27;.</span><br>                    <span class=\"hljs-keyword\">var</span> src = $(<span class=\"hljs-variable language_\">this</span>).<span class=\"hljs-title function_\">attr</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-string\">&#x27;\\\\&#x27;</span>, <span class=\"hljs-string\">&#x27;/&#x27;</span>);<br>                    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-regexp\">/http[s]*.*|\\/\\/.*/</span>.<span class=\"hljs-title function_\">test</span>(src) &amp;&amp;<br>                        !<span class=\"hljs-regexp\">/^\\s*\\//</span>.<span class=\"hljs-title function_\">test</span>(src)) &#123;<br>                        <span class=\"hljs-comment\">// For &quot;about&quot; page, the first part of &quot;src&quot; can&#x27;t be removed.</span><br>                        <span class=\"hljs-comment\">// In addition, to support multi-level local directory.</span><br>                        <span class=\"hljs-keyword\">var</span> linkArray = link.<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;/&#x27;</span>).<span class=\"hljs-title function_\">filter</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">elem</span>) &#123;<br>                            <span class=\"hljs-keyword\">return</span> elem != <span class=\"hljs-string\">&#x27;&#x27;</span>;<br>                        &#125;);<br>                        <span class=\"hljs-keyword\">var</span> srcArray = src.<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;/&#x27;</span>).<span class=\"hljs-title function_\">filter</span>(<span class=\"hljs-keyword\">function</span> (<span class=\"hljs-params\">elem</span>) &#123;<br>                            <span class=\"hljs-keyword\">return</span> elem != <span class=\"hljs-string\">&#x27;&#x27;</span> &amp;&amp; elem != <span class=\"hljs-string\">&#x27;.&#x27;</span>;<br>                        &#125;);<br>                        <span class=\"hljs-keyword\">if</span> (srcArray.<span class=\"hljs-property\">length</span> &gt; <span class=\"hljs-number\">1</span>)<br>                            srcArray.<span class=\"hljs-title function_\">shift</span>();<br>                        src = srcArray.<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;/&#x27;</span>);<br>                        $(<span class=\"hljs-variable language_\">this</span>).<span class=\"hljs-title function_\">attr</span>(<span class=\"hljs-string\">&#x27;src&#x27;</span>, config.<span class=\"hljs-property\">root</span> + link + src);<br>                        <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-property\">info</span> &amp;&amp; <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">info</span>(<span class=\"hljs-string\">&quot;update link as:--&gt;&quot;</span> + config.<span class=\"hljs-property\">root</span> + link + src);<br>                    &#125;<br>                &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>                    <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-property\">info</span> &amp;&amp; <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">info</span>(<span class=\"hljs-string\">&quot;no src attr, skipped...&quot;</span>);<br>                    <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-property\">info</span> &amp;&amp; <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">info</span>($(<span class=\"hljs-variable language_\">this</span>));<br>                &#125;<br>            &#125;);<br>            data[key] = $.<span class=\"hljs-title function_\">html</span>();<br>        &#125;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>\n<p>修改完毕之后生成的地址就是正常理想的路径了：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">update link as:--&gt;/2022/08/09/%E9%9D%A2%E8%AF%95%E9%A2%98/Linux/02-%E6%9D%83%E9%99%90/img.png<br>update link as:--&gt;/2022/08/09/%E9%9D%A2%E8%AF%95%E9%A2%98/Linux/02-%E6%9D%83%E9%99%90/img.png<br></code></pre></td></tr></table></figure>\n<blockquote>\n<p>hexo 3.0 以上用户应该也可以选择直接卸载 hexo-asset-image 插件，直接使用官方的相对路径引用的标签插件 <a href=\"https://hexo.io/zh-cn/docs/asset-folders\" target=\"_blank\">https://hexo.io/zh-cn/docs/asset-folders</a></p>\n</blockquote>\n","prev":{"title":"MongoDB-聚合操作$group","link":"2022/08/13/MongoDB/01-MongoDB-聚合操作$group"},"next":{"title":"Java","link":"2022/08/10/Java/Java"},"plink":"http://example.com/2022/08/13/Hexo/02-hexo-asset-image 上传图片编译路径的BUG/","toc":[{"id":"解决方式","title":"解决方式","index":"1","children":[{"id":"hexo-3.0-以下","title":"hexo 3.0 以下","index":"1.1"}]}],"reading_time":"675 words in 5 min"}