{"title":"MongoDB-分片集群搭建","date":"2022-10-23T15:34:42.000Z","date_formatted":{"ll":"Oct 23, 2022","L":"10/23/2022","MM-DD":"10-23"},"link":"2022/10/23/MongoDB/MongoDB-分片/07-MongoDB-分片集群搭建","tags":["MongoDB"],"updated":"2022-11-02T16:56:51.010Z","content":"<h1 id=\"分片集群搭建\">分片集群搭建<a title=\"#分片集群搭建\" href=\"#分片集群搭建\"></a></h1>\n<p>搭建配置服务器复制集:</p>\n<ul>\n<li>早期版本的配置服务器只要一台即可</li>\n<li>最新版本 MongoDB 要求配置服务器必须是一个复制集</li>\n</ul>\n<p>搭建分片服务器复制集：</p>\n<ul>\n<li>用于保存数据的多台电脑</li>\n</ul>\n<p>搭建路由服务器：</p>\n<ul>\n<li>用于建立配置服务器和分片服务器之间的关系</li>\n</ul>\n<h1 id=\"搭建配置服务器集群\">搭建配置服务器集群<a title=\"#搭建配置服务器集群\" href=\"#搭建配置服务器集群\"></a></h1>\n<h2 id=\"编写配置文件\">编写配置文件<a title=\"#编写配置文件\" href=\"#编写配置文件\"></a></h2>\n<p>注意这里是下载了一台全新的 MongoDB 再次进行的搭建的，这里不介绍全新的去哪里下载前面有，然后更改配置文件内容如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\"># 数据保存到哪<br>storage:<br>  dbPath: D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-config-27018\\data<br>  journal:<br>    enabled: true<br><br># 日志保存到哪<br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path: D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-config-27018\\log<br><br># 绑定的IP和端口号<br>net:<br>  port: 27018<br>  bindIp: 127.0.0.1<br><br># 复制集名称<br>replication:<br>  replSetName: &#x27;it6666&#x27;<br><br># 复制集的作用<br>sharding:<br>  clusterRole: configsvr<br></code></pre></td></tr></table></figure>\n<p>?&gt; 这里是一个集群的，所以关于其它两台自己分别去更改端口号进行搭建</p>\n<h2 id=\"注册-mongodb-服务\">注册 MongoDB 服务<a title=\"#注册-mongodb-服务\" href=\"#注册-mongodb-服务\"></a></h2>\n<p>管理员权限运行终端, 执行如下指令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongod --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-config-27018\\config\\mongo.config --serviceName &quot;MongoDB27018&quot; --serviceDisplayName &quot;MongoDB27018&quot;  --install<br>mongod --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-config-27019\\config\\mongo.config --serviceName &quot;MongoDB27019&quot; --serviceDisplayName &quot;MongoDB27019&quot;  --install<br>mongod --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-config-27020\\config\\mongo.config --serviceName &quot;MongoDB27020&quot; --serviceDisplayName &quot;MongoDB27020&quot;  --install<br></code></pre></td></tr></table></figure>\n<p>在任务管理器中开启任务：</p>\n<p><img src=\"https://img2022.cnblogs.com/blog/2105804/202210/2105804-20221030110907574-1608891955.png\" alt=\"image-20221030110906075\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"测试服务可用性\">测试服务可用性<a title=\"#测试服务可用性\" href=\"#测试服务可用性\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongo --host 127.0.0.1 --port 27018<br>mongo --host 127.0.0.1 --port 27019<br>mongo --host 127.0.0.1 --port 27020<br></code></pre></td></tr></table></figure>\n<h2 id=\"添加复制集\">添加复制集<a title=\"#添加复制集\" href=\"#添加复制集\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">rs.initiate(&#123;<br>_id: &#x27;it6666&#x27;,<br>configsvr: true,<br>members: [<br>        &#123;_id: 0, host: &#x27;127.0.0.1: 27018&#x27;<br>        &#125;,<br>        &#123;_id: 1, host: &#x27;127.0.0.1: 27019&#x27;<br>        &#125;,<br>        &#123;_id: 2, host: &#x27;127.0.0.1: 27020&#x27;<br>        &#125;<br>    ]<br>&#125;)<br></code></pre></td></tr></table></figure>\n<h1 id=\"搭建分片服务器集群\">搭建分片服务器集群<a title=\"#搭建分片服务器集群\" href=\"#搭建分片服务器集群\"></a></h1>\n<p>编写配置文件：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\"># 数据保存到哪<br>storage:<br>  dbPath: D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-shard-27023\\data<br>  journal:<br>    enabled: true<br><br># 日志保存到哪<br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path: D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-shard-27023\\log\\mongod.log<br>  <br># 绑定的IP和端口号<br>net:<br>  port: 27023<br>  bindIp: 127.0.0.1<br>  <br># 复制集名称<br>replication:<br>  replSetName: &#x27;BNTang_It6666&#x27;<br>  <br># 复制集的作用<br>sharding:<br>    clusterRole: shardsvr<br></code></pre></td></tr></table></figure>\n<p>?&gt; 这里是一个集群的，所以关于其它两台自己分别去更改端口号进行搭建</p>\n<h2 id=\"注册-mongodb-服务-1\">注册 MongoDB 服务<a title=\"#注册-mongodb-服务-1\" href=\"#注册-mongodb-服务-1\"></a></h2>\n<p>管理员权限运行终端, 执行如下指令:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongod --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-shard-27021\\config\\mongo.config --serviceName &quot;MongoDB27021&quot; --serviceDisplayName &quot;MongoDB27021&quot;  --install<br>mongod --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-shard-27022\\config\\mongo.config --serviceName &quot;MongoDB27022&quot; --serviceDisplayName &quot;MongoDB27022&quot;  --install<br>mongod --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-shard-27023\\config\\mongo.config --serviceName &quot;MongoDB27023&quot; --serviceDisplayName &quot;MongoDB27023&quot;  --install<br></code></pre></td></tr></table></figure>\n<p>在任务管理器中开启任务：</p>\n<p><img src=\"https://img2022.cnblogs.com/blog/2105804/202211/2105804-20221102224858829-973027502.png\" alt=\"image-20221102224857077\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"测试服务可用性-1\">测试服务可用性<a title=\"#测试服务可用性-1\" href=\"#测试服务可用性-1\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongo --host 127.0.0.1 --port 27021<br>mongo --host 127.0.0.1 --port 27022<br>mongo --host 127.0.0.1 --port 27023<br></code></pre></td></tr></table></figure>\n<h2 id=\"添加复制集-1\">添加复制集<a title=\"#添加复制集-1\" href=\"#添加复制集-1\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">rs.initiate(&#123;<br>  _id: &#x27;BNTang_It6666&#x27;,<br>  members: [<br>    &#123;_id: 0, host: &#x27;127.0.0.1:27021&#x27;&#125;,<br>    &#123;_id: 1, host: &#x27;127.0.0.1:27022&#x27;&#125;,<br>    &#123;_id: 2, host: &#x27;127.0.0.1:27023&#x27;&#125;]<br>&#125;)<br></code></pre></td></tr></table></figure>\n<h1 id=\"搭建路由服务器\">搭建路由服务器<a title=\"#搭建路由服务器\" href=\"#搭建路由服务器\"></a></h1>\n<h2 id=\"编写配置文件-1\">编写配置文件<a title=\"#编写配置文件-1\" href=\"#编写配置文件-1\"></a></h2>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\"># 日志保存到哪<br>systemLog:<br>  destination: file<br>  logAppend: true<br>  path: D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-router-27024\\log\\mongod.log<br><br># 绑定的IP和端口号<br>net:<br>  port: 27024<br>  bindIp: 127.0.0.1<br>  <br># 配置服务器地址<br>sharding:<br>  configDB: it6666/127.0.0.1:27018,127.0.0.1:27019,127.0.0.1:27020<br></code></pre></td></tr></table></figure>\n<h2 id=\"注册-mongodb-服务-2\">注册 MongoDB 服务<a title=\"#注册-mongodb-服务-2\" href=\"#注册-mongodb-服务-2\"></a></h2>\n<p>管理员权限运行终端, 执行如下指令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongos --config D:\\Web\\MongoDB4.X\\MongoDBSharding\\mongodb-router-27024\\config\\mongo.config --serviceName &quot;MongoDB27024&quot; --serviceDisplayName &quot;MongoDB27024&quot;  --install<br></code></pre></td></tr></table></figure>\n<p>在任务管理器中开启任务：</p>\n<p><img src=\"https://img2022.cnblogs.com/blog/2105804/202211/2105804-20221102234426748-76563530.png\" alt=\"image-20221102234425262\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"测试服务可用性-2\">测试服务可用性<a title=\"#测试服务可用性-2\" href=\"#测试服务可用性-2\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">mongo --host 127.0.0.1 --port 27024<br></code></pre></td></tr></table></figure>\n<h2 id=\"添加分片服务器\">添加分片服务器<a title=\"#添加分片服务器\" href=\"#添加分片服务器\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sh.addShard( &quot;BNTang_It6666/127.0.0.1:27021&quot;)<br>sh.addShard( &quot;BNTang_It6666/127.0.0.1:27022&quot;)<br>sh.addShard( &quot;BNTang_It6666/127.0.0.1:27023&quot;)<br></code></pre></td></tr></table></figure>\n<h2 id=\"给指定数据库开启分片\">给指定数据库开启分片<a title=\"#给指定数据库开启分片\" href=\"#给指定数据库开启分片\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sh.enableSharding(&quot;demo&quot;)<br></code></pre></td></tr></table></figure>\n<h2 id=\"指定分片片键\">指定分片片键<a title=\"#指定分片片键\" href=\"#指定分片片键\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sh.shardCollection(&quot;demo.user&quot;,&#123;&#x27;age&#x27;:1&#125;)<br></code></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sh.shardCollection(&quot;demo.user&quot;,&#123;&#x27;name&#x27;:hashed&#125;)<br></code></pre></td></tr></table></figure>","prev":{"title":"Redis 单线程为什么还能这么快","link":"2022/10/24/面试题/Redis/01-Redis 单线程为什么还能这么快"},"next":{"title":"MongoDB-分片查询","link":"2022/10/23/MongoDB/MongoDB-分片/06-MongoDB-分片查询"},"plink":"http://example.com/2022/10/23/MongoDB/MongoDB-分片/07-MongoDB-分片集群搭建/","toc":[{"id":"分片集群搭建","title":"分片集群搭建","index":"1"},{"id":"搭建配置服务器集群","title":"搭建配置服务器集群","index":"2","children":[{"id":"编写配置文件","title":"编写配置文件","index":"2.1"},{"id":"注册-mongodb-服务","title":"注册 MongoDB 服务","index":"2.2"},{"id":"测试服务可用性","title":"测试服务可用性","index":"2.3"},{"id":"添加复制集","title":"添加复制集","index":"2.4"}]},{"id":"搭建分片服务器集群","title":"搭建分片服务器集群","index":"3","children":[{"id":"注册-mongodb-服务-1","title":"注册 MongoDB 服务","index":"3.1"},{"id":"测试服务可用性-1","title":"测试服务可用性","index":"3.2"},{"id":"添加复制集-1","title":"添加复制集","index":"3.3"}]},{"id":"搭建路由服务器","title":"搭建路由服务器","index":"4","children":[{"id":"编写配置文件-1","title":"编写配置文件","index":"4.1"},{"id":"注册-mongodb-服务-2","title":"注册 MongoDB 服务","index":"4.2"},{"id":"测试服务可用性-2","title":"测试服务可用性","index":"4.3"},{"id":"添加分片服务器","title":"添加分片服务器","index":"4.4"},{"id":"给指定数据库开启分片","title":"给指定数据库开启分片","index":"4.5"},{"id":"指定分片片键","title":"指定分片片键","index":"4.6"}]}],"reading_time":"1035 words in 7 min"}