{"title":"MongoDB-唯一索引","date":"2022-08-28T04:39:31.000Z","date_formatted":{"ll":"Aug 28, 2022","L":"08/28/2022","MM-DD":"08-28"},"link":"2022/08/28/MongoDB/索引/05-MongoDB-唯一索引","tags":["MongoDB"],"updated":"2022-08-28T05:22:50.197Z","content":"<h1 id=\"唯一索引\">唯一索引<a title=\"#唯一索引\" href=\"#唯一索引\"></a></h1>\n<p>默认情况下 MongoDB 和 MySQL 一样, 都会自动为主键创建索引, 这个索引就是一个唯一索引，除了主键可以作为唯一索引以外, 只要某个字段的取值是唯一的, 我们也可以手动给这个字段添加唯一索引。</p>\n<p>书写格式：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.&lt;collection&gt;.createIndex(<span class=\"hljs-punctuation\">&#123;</span>&lt;field&gt;<span class=\"hljs-punctuation\">:</span> &lt;<span class=\"hljs-number\">1</span> or <span class=\"hljs-number\">-1</span>&gt;<span class=\"hljs-punctuation\">,</span> ...<span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-punctuation\">&#123;</span>unique<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">true</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>添加测试数据：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.insert(<span class=\"hljs-punctuation\">[</span><br><span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;cs&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">19</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;as&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">18</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;bs&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">17</span><span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">]</span>)<br></code></pre></td></tr></table></figure>\n<p>查看目前已有索引：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.getIndexes()<br></code></pre></td></tr></table></figure>\n<p>查询结果：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">[<br>    &#123;<br>        &quot;v&quot; : 2,<br>        &quot;key&quot; : &#123;<br>            &quot;_id&quot; : 1<br>        &#125;,<br>        &quot;name&quot; : &quot;_id_&quot;,<br>        &quot;ns&quot; : &quot;test.person&quot;<br>    &#125;<br>]<br></code></pre></td></tr></table></figure>\n<p>创建唯一索引：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.createIndex(<span class=\"hljs-punctuation\">&#123;</span>age<span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-punctuation\">&#123;</span>unique<span class=\"hljs-punctuation\">:</span><span class=\"hljs-keyword\">true</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>再次添加数据：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.insert(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;zs&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">20</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>因为我们添加的测试数据当中不存在 age 等于 20 的所以第一次是可以进行插入成功的，你在运行一次就会发现报错了，报错信息如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">WriteResult(&#123;<br>    &quot;nInserted&quot; : 0,<br>    &quot;writeError&quot; : &#123;<br>        &quot;code&quot; : 11000,<br>        &quot;errmsg&quot; : &quot;E11000 duplicate key error collection: test.person index: age_1 dup key: &#123; : 20.0 &#125;&quot;<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>\n<p>!&gt; 如果为某个字段添加了唯一索引, 那么就不能再给这个字段添加重复的值</p>\n<p>!&gt; 如果插入的数据中没有包含唯一索引的字段, 那么第一次会自动用 null 填充, 第二次会报错</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.insert(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;ls&#x27;<span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>第一次运行插入不会报错，第二次运行结果如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">WriteResult(&#123;<br>    &quot;nInserted&quot; : 0,<br>    &quot;writeError&quot; : &#123;<br>        &quot;code&quot; : 11000,<br>        &quot;errmsg&quot; : &quot;E11000 duplicate key error collection: test.person index: age_1 dup key: &#123; : null &#125;&quot;<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>\n<p>!&gt; 如果是复合唯一索引, 那么是复合字段的组合不能重复</p>\n<p>创建复合索引：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.createIndex(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span>age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span> <span class=\"hljs-punctuation\">&#123;</span>unique<span class=\"hljs-punctuation\">:</span><span class=\"hljs-keyword\">true</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>插入数据：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.insert(<span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;ww&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">22</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>第一次插入是成功的，第二次会失败会报错。</p>\n","prev":{"title":"MongoDB-稀疏索引","link":"2022/08/28/MongoDB/索引/06-MongoDB-稀疏索引"},"next":{"title":"MongoDB-索引对排序影响","link":"2022/08/28/MongoDB/索引/04-MongoDB-索引对排序影响"},"plink":"http://example.com/2022/08/28/MongoDB/索引/05-MongoDB-唯一索引/","toc":[{"id":"唯一索引","title":"唯一索引","index":"1"}],"reading_time":"457 words in 3 min"}