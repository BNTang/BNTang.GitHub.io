{"title":"MongoDB-多键索引","date":"2022-08-21T06:29:32.000Z","date_formatted":{"ll":"Aug 21, 2022","L":"08/21/2022","MM-DD":"08-21"},"link":"2022/08/21/MongoDB/索引/03-MongoDB-多键索引","tags":["MongoDB"],"updated":"2022-08-21T06:35:05.370Z","content":"<h1 id=\"多键索引\">多键索引<a title=\"#多键索引\" href=\"#多键索引\"></a></h1>\n<p>多键索引是专门针对数组字段的, 会为数组字段的每一个元素都创建一个索引。</p>\n<p>?&gt; 插入测试数据：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.insert(<span class=\"hljs-punctuation\">[</span><br><span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;as&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">18</span><span class=\"hljs-punctuation\">,</span> tags<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">[</span>&#x27;ahtml&#x27;<span class=\"hljs-punctuation\">,</span> &#x27;bcss&#x27;<span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;bs&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">17</span><span class=\"hljs-punctuation\">,</span> tags<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">[</span>&#x27;cjs&#x27;<span class=\"hljs-punctuation\">,</span> &#x27;enode&#x27;<span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-punctuation\">&#123;</span>name<span class=\"hljs-punctuation\">:</span>&#x27;cs&#x27;<span class=\"hljs-punctuation\">,</span> age<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">19</span><span class=\"hljs-punctuation\">,</span> tags<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">[</span> &#x27;dvue&#x27;<span class=\"hljs-punctuation\">,</span> &#x27;freact&#x27;<span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br><span class=\"hljs-punctuation\">]</span>)<br></code></pre></td></tr></table></figure>\n<p>首先来看看我们没有创建多键索引之前的查询效果：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.explain().find(<span class=\"hljs-punctuation\">&#123;</span>&#x27;tags&#x27;<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">&#123;</span>$in<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">[</span>&#x27;ahtml&#x27;<span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>从如下结果集返回来看，是一个全表扫描的情况：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;queryPlanner&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;plannerVersion&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;namespace&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;test.person&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;indexFilterSet&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">false</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;parsedQuery&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;tags&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;$eq&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ahtml&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;winningPlan&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;stage&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;COLLSCAN&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;filter&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;tags&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                    <span class=\"hljs-attr\">&quot;$eq&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ahtml&quot;</span><br>                <span class=\"hljs-punctuation\">&#125;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;direction&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;forward&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rejectedPlans&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span> <span class=\"hljs-punctuation\">]</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;serverInfo&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;LAPTOP-A8CAC6IT&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;port&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">27017</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;version&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;4.0.28&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;gitVersion&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;af1a9dc12adcfa83cc19571cb3faba26eeddac92&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ok&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<p>创建多键索引：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.createIndex(<span class=\"hljs-punctuation\">&#123;</span>tags<span class=\"hljs-punctuation\">:</span><span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>再次进行查询：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\">db.person.explain().find(<span class=\"hljs-punctuation\">&#123;</span>&#x27;tags&#x27;<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">&#123;</span>$in<span class=\"hljs-punctuation\">:</span><span class=\"hljs-punctuation\">[</span>&#x27;ahtml&#x27;<span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">&#125;</span>)<br></code></pre></td></tr></table></figure>\n<p>返回结果：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;queryPlanner&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;plannerVersion&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;namespace&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;test.person&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;indexFilterSet&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">false</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;parsedQuery&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;tags&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;$eq&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;ahtml&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;winningPlan&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;stage&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;FETCH&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;inputStage&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;stage&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;IXSCAN&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;keyPattern&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                    <span class=\"hljs-attr\">&quot;tags&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><br>                <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;indexName&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;tags_1&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;isMultiKey&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">true</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;multiKeyPaths&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                    <span class=\"hljs-attr\">&quot;tags&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                        <span class=\"hljs-string\">&quot;tags&quot;</span><br>                    <span class=\"hljs-punctuation\">]</span><br>                <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;isUnique&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">false</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;isSparse&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">false</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;isPartial&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-keyword\">false</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;indexVersion&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">2</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;direction&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;forward&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;indexBounds&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                    <span class=\"hljs-attr\">&quot;tags&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                        <span class=\"hljs-string\">&quot;[\\&quot;ahtml\\&quot;, \\&quot;ahtml\\&quot;]&quot;</span><br>                    <span class=\"hljs-punctuation\">]</span><br>                <span class=\"hljs-punctuation\">&#125;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;rejectedPlans&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span> <span class=\"hljs-punctuation\">]</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;serverInfo&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;host&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;LAPTOP-A8CAC6IT&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;port&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">27017</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;version&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;4.0.28&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;gitVersion&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;af1a9dc12adcfa83cc19571cb3faba26eeddac92&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;ok&quot;</span> <span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">1</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<p>很明显是通过索引进行命中对应的数据。</p>\n<p>在我们创建了对应了多键索引之后，我们插入的测试数据对应的数据结构大概的体系结构如下可以进行稍微了解了解：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs text\">&#x27;ahtml&#x27; -&gt; &#123;name:&#x27;as&#x27;, age:18, tags:[&#x27;ahtml&#x27;, &#x27;bcss&#x27;]&#125;<br>&#x27;bcss&#x27; -&gt; &#123;name:&#x27;as&#x27;, age:18, tags:[&#x27;ahtml&#x27;, &#x27;bcss&#x27;]&#125;<br>&#x27;cjs&#x27; -&gt; &#123;name:&#x27;bs&#x27;, age:17, tags:[&#x27;cjs&#x27;, &#x27;enode&#x27;]&#125;<br>&#x27;dvue&#x27; -&gt; &#123;name:&#x27;cs&#x27;, age:19, tags:[ &#x27;dvue&#x27;, &#x27;freact&#x27;]&#125;<br>&#x27;enode&#x27; -&gt; &#123;name:&#x27;bs&#x27;, age:17, tags:[&#x27;cjs&#x27;, &#x27;enode&#x27;]&#125;<br>&#x27;freact&#x27; -&gt; &#123;name:&#x27;cs&#x27;, age:19, tags:[ &#x27;dvue&#x27;, &#x27;freact&#x27;]&#125;<br></code></pre></td></tr></table></figure>","prev":{"title":"MongoDB-索引对排序影响","link":"2022/08/28/MongoDB/索引/04-MongoDB-索引对排序影响"},"next":{"title":"MongoDB-复合索引","link":"2022/08/20/MongoDB/索引/02-MongoDB-复合索引"},"plink":"http://example.com/2022/08/21/MongoDB/索引/03-MongoDB-多键索引/","toc":[{"id":"多键索引","title":"多键索引","index":"1"}],"reading_time":"441 words in 3 min"}