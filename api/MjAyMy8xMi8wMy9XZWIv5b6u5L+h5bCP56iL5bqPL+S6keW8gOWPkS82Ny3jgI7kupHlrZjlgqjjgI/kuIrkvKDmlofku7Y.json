{"title":"『云存储』上传文件","date":"2023-12-03T09:46:02.000Z","date_formatted":{"ll":"Dec 3, 2023","L":"12/03/2023","MM-DD":"12-03"},"link":"2023/12/03/Web/微信小程序/云开发/67-『云存储』上传文件","tags":["云开发","微信小程序"],"updated":"2024-03-04T02:19:39.729Z","content":"<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202312/2105804-20231203183532867-288536861.png\" alt loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"一、前言\">一、前言<a title=\"#一、前言\" href=\"#一、前言\"></a></h1>\n<blockquote>\n<ul>\n<li>本篇文章是『云存储』文章的第 1 篇，主要介绍『云存储』上传文件</li>\n</ul>\n</blockquote>\n<p>通过前几篇文章，已经全面讲解了微信云数据库的 CRUD（创建、读取、更新、删除）操作。现在，我将向大家展示如何使用微信云存储服务，具体来说，我们会学习如何通过编写代码将文件上传到云端存储中。</p>\n<h1 id=\"二、搭建环境\">二、搭建环境<a title=\"#二、搭建环境\" href=\"#二、搭建环境\"></a></h1>\n<p>为了实现代码的触发，我们首先要构建基础的交互元素。具体来说，需要修改 <code>pages/cloud-storage/index.wxml</code> 文件，来搭建基础的页面布局。我们将主要加入四个功能按钮，以实现不同的操作。相关的代码展示如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;primary&quot;</span> <span class=\"hljs-attr\">bindtap</span>=<span class=\"hljs-string\">&quot;onUpTap&quot;</span>&gt;</span>上传<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;primary&quot;</span> <span class=\"hljs-attr\">bindtap</span>=<span class=\"hljs-string\">&quot;onDownTap&quot;</span>&gt;</span>下载<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;primary&quot;</span> <span class=\"hljs-attr\">bindtap</span>=<span class=\"hljs-string\">&quot;onDelTap&quot;</span>&gt;</span>删除<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span><br><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">button</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;primary&quot;</span> <span class=\"hljs-attr\">bindtap</span>=<span class=\"hljs-string\">&quot;onTempPathTap&quot;</span>&gt;</span>获取临时路径<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">button</span>&gt;</span><br></code></pre></td></tr></table></figure>\n<p>我们已经完成了页面结构的代码编写。下一步，将转向 <code>pages/cloud-storage/index.js</code> 文件，以便添加相关按钮的点击事件处理函数。下面是具体的实现代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-title class_\">Page</span>(&#123;<br>    <span class=\"hljs-title function_\">onUpTap</span>(<span class=\"hljs-params\"></span>) &#123;<br>    &#125;,<br>    <span class=\"hljs-title function_\">onDownTap</span>(<span class=\"hljs-params\"></span>) &#123;<br>    &#125;,<br>    <span class=\"hljs-title function_\">onDelTap</span>(<span class=\"hljs-params\"></span>) &#123;<br>    &#125;,<br>    <span class=\"hljs-title function_\">onTempPathTap</span>(<span class=\"hljs-params\"></span>) &#123;<br>    &#125;,<br>&#125;)<br></code></pre></td></tr></table></figure>\n<p>至此，页面结构与相关逻辑都已搭建完毕，可以继续往下学习。</p>\n<h1 id=\"三.上传文件\">三.上传文件<a title=\"#三.上传文件\" href=\"#三.上传文件\"></a></h1>\n<p>正如前文所述，在进行云数据库操作前，必须先获取数据库的引用才能执行增、删、改、查等操作。云存储的使用逻辑也如出一辙，我们需要先获得云存储的引用，之后才能顺利进行文件上传等相关操作。</p>\n<p>那么，我们如何获取到云存储的引用呢？操作起来非常简便。只需使用 <code>wx.cloud</code> 这一接口，我们就可以轻松获取云存储的引用，然后利用 <code>uploadFile</code> 方法进行文件上传。</p>\n<h2 id=\"3.1.上传文件到云存储\">3.1.上传文件到云存储<a title=\"#3.1.上传文件到云存储\" href=\"#3.1.上传文件到云存储\"></a></h2>\n<p>我们先来看一段代码示例，之后将对其进行详细解释：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-keyword\">async</span> <span class=\"hljs-title function_\">onUpTap</span>(<span class=\"hljs-params\"></span>) &#123;<br>    <span class=\"hljs-comment\">// 1. 拿到相册中的图片</span><br>    <span class=\"hljs-keyword\">const</span> images = <span class=\"hljs-keyword\">await</span> wx.<span class=\"hljs-title function_\">chooseMedia</span>(&#123;<br>      <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&quot;image&quot;</span><br>    &#125;);<br><br>    <span class=\"hljs-keyword\">const</span> imagePath = images.<span class=\"hljs-property\">tempFiles</span>[<span class=\"hljs-number\">0</span>].<span class=\"hljs-property\">tempFilePath</span>;<br><br>    <span class=\"hljs-comment\">// 2.动态生成文件名称</span><br>    <span class=\"hljs-keyword\">const</span> timeStamp = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>().<span class=\"hljs-title function_\">getTime</span>();<br><br>    <span class=\"hljs-comment\">// 文件后缀</span><br>    <span class=\"hljs-keyword\">const</span> extension = imagePath.<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&quot;.&quot;</span>).<span class=\"hljs-title function_\">pop</span>();<br>    <span class=\"hljs-keyword\">const</span> cloudPath = <span class=\"hljs-string\">`test/<span class=\"hljs-subst\">$&#123;timeStamp&#125;</span>.<span class=\"hljs-subst\">$&#123;extension&#125;</span>`</span>;<br><br>    <span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> wx.<span class=\"hljs-property\">cloud</span>.<span class=\"hljs-title function_\">uploadFile</span>(&#123;<br>      <span class=\"hljs-comment\">// 被上传文件路径</span><br>      <span class=\"hljs-attr\">filePath</span>: imagePath,<br>      <span class=\"hljs-comment\">// 存储在云端路径</span><br>      <span class=\"hljs-attr\">cloudPath</span>: cloudPath<br>    &#125;);<br><br>    <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(res);<br>&#125;,<br></code></pre></td></tr></table></figure>\n<h2 id=\"3.2.代码解释\">3.2.代码解释<a title=\"#3.2.代码解释\" href=\"#3.2.代码解释\"></a></h2>\n<p>为了逐步理解整段代码，我们首先从获取相册中图片这一步开始讲解：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-keyword\">const</span> images = <span class=\"hljs-keyword\">await</span> wx.<span class=\"hljs-title function_\">chooseMedia</span>(&#123;<br>    <span class=\"hljs-attr\">type</span>: <span class=\"hljs-string\">&quot;image&quot;</span><br>&#125;);<br></code></pre></td></tr></table></figure>\n<p>首先，利用 <code>wx.chooseMedia</code> 方法，我们能够浏览相册并选取照片。选取完成后，所选图片的路径便会被保存至 <code>imagePath</code> 变量中：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-keyword\">const</span> imagePath = images.<span class=\"hljs-property\">tempFiles</span>[<span class=\"hljs-number\">0</span>].<span class=\"hljs-property\">tempFilePath</span>;<br></code></pre></td></tr></table></figure>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202401/2105804-20240114124449513-1659140718.png\" alt loading=\"lazy\" class=\"φbp\"></p>\n<p>下一步是为文件动态生成一个名称。我们通过调用 <code>new Date().getTime()</code> 获取当前的时间戳，并使用它作为文件名的一部分来确保其唯一性。同时，我们还需提取文件的扩展名，以便于在云存储中正确地识别文件类型。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-keyword\">const</span> timeStamp = <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Date</span>().<span class=\"hljs-title function_\">getTime</span>();<br><br><span class=\"hljs-comment\">// 文件后缀</span><br><span class=\"hljs-keyword\">const</span> extension = imagePath.<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&quot;.&quot;</span>).<span class=\"hljs-title function_\">pop</span>();<br><span class=\"hljs-keyword\">const</span> cloudPath = <span class=\"hljs-string\">`test/<span class=\"hljs-subst\">$&#123;timeStamp&#125;</span>.<span class=\"hljs-subst\">$&#123;extension&#125;</span>`</span>;<br></code></pre></td></tr></table></figure>\n<p>最终步骤是将图片上传到云存储，这可以通过 <code>wx.cloud.uploadFile</code> 方法实现。调用该方法时，需要提供两个关键参数：一是 <code>filePath</code>，表示待上传文件所在的本地路径；二是 <code>cloudPath</code>，指定文件在云端存储中的目标路径。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-keyword\">const</span> res = <span class=\"hljs-keyword\">await</span> wx.<span class=\"hljs-property\">cloud</span>.<span class=\"hljs-title function_\">uploadFile</span>(&#123;<br>    <span class=\"hljs-comment\">// 被上传文件路径</span><br>    <span class=\"hljs-attr\">filePath</span>: imagePath,<br>    <span class=\"hljs-comment\">// 存储在云端路径</span><br>    <span class=\"hljs-attr\">cloudPath</span>: cloudPath<br>&#125;);<br><br><span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(res);<br></code></pre></td></tr></table></figure>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202401/2105804-20240114124929815-1660149191.png\" alt loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"四、上传结果\">四、上传结果<a title=\"#四、上传结果\" href=\"#四、上传结果\"></a></h1>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202401/2105804-20240114125229914-449155986.png\" alt loading=\"lazy\" class=\"φbp\"></p>\n<p>注意到创建了一个名为 “test” 的文件夹，并且图片被上传到了这个文件夹里。这是由于我们在 <code>cloudPath</code> 参数中预设了云端的存储路径，因此出现了这个结果。</p>\n<p>若需上传图片或文件到特定文件夹，只须修改 <code>cloudPath</code> 参数，设定为期望的云端路径即可。</p>\n<p>进入 “test” 文件夹查看，可以确认图片已成功上传。<img src=\"https://img2023.cnblogs.com/blog/2105804/202401/2105804-20240114125328402-560837758.png\" alt loading=\"lazy\"></p>\n<h1 id=\"五、总结\">五、总结<a title=\"#五、总结\" href=\"#五、总结\"></a></h1>\n<p>通过本文的学习，您将能够掌握以下核心知识点：</p>\n<ul>\n<li>1.如何使用 <code>wx.chooseMedia</code> 方法从相册中选取图片</li>\n<li>2.如何使用 <code>wx.cloud.uploadFile</code> 方法将图片上传至云存储</li>\n<li>3.如何动态生成文件名称，以确保文件名的唯一性</li>\n<li>4.如何在云存储中创建文件夹，并将文件上传至指定文件夹</li>\n</ul>\n<blockquote>\n<p>最后，我要感谢您阅读本文。如果您觉得文章有用，请不吝点赞、收藏或者转发。您的支持是我不断创作与分享的最大动力。让我们携手在学习的旅途上相互促进，共同享受知识带来的快乐。</p>\n</blockquote>\n<p><img src=\"https://img2023.cnblogs.com/blog/2105804/202312/2105804-20231211215004818-977875224.png\" alt loading=\"lazy\" class=\"φbp\"></p>\n","prev":{"title":"『云数据库』更新数据","link":"2023/12/03/Web/微信小程序/云开发/65-『云数据库』更新数据"},"next":{"title":"『云存储』下载文件","link":"2023/12/03/Web/微信小程序/云开发/68-『云存储』下载文件"},"plink":"http://example.com/2023/12/03/Web/微信小程序/云开发/67-『云存储』上传文件/","toc":[{"id":"一、前言","title":"一、前言","index":"1"},{"id":"二、搭建环境","title":"二、搭建环境","index":"2"},{"id":"三.上传文件","title":"三.上传文件","index":"3","children":[{"id":"3.1.上传文件到云存储","title":"3.1.上传文件到云存储","index":"3.1"},{"id":"3.2.代码解释","title":"3.2.代码解释","index":"3.2"}]},{"id":"四、上传结果","title":"四、上传结果","index":"4"},{"id":"五、总结","title":"五、总结","index":"5"}]}